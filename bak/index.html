<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <link rel="stylesheet" href="./css/index.css" />
    <link rel="stylesheet" href="./css/_swiper-bundle.min.css">
    <title>好营养 源来有话说</title>
    <meta name="description" content="从好原料到好营养，一起来聆听营养源头的自然之声">
    <script>
        function setFS() {
            var html = document.querySelector('html');
            var width = html.getBoundingClientRect().width;
            html.style.fontSize = width / 1000 + 'px';
        }
        setFS();
        window.addEventListener('resize', setFS);
    </script>
    <script>
        (function (w, d, s, q, i) {
            w[q] = w[q] || [];
            var f = d.getElementsByTagName(s)[0], j = d.createElement(s);
            j.async = true;
            j.id = 'beacon-aplus';
            j.src = 'https://d.alicdn.com/alilog/mlog/aplus/' + i + '.js';
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'aplus_queue', '203467608');

        //集成应用的appKey
        aplus_queue.push({
            action: 'aplus.setMetaInfo',
            arguments: ['appKey', '65258f2cb2f6fa00ba618cdd']
        });
    </script>
    <script src='https://res.wx.qq.com/open/js/jweixin-1.6.0.js' type='text/javascript'></script>
    <script src="https://s1.xmcdn.com/yx/web-jssdk/1.5.1/dist_cdn/xmsdk.min.js"></script>
    <script src="https://s1.xmcdn.com/lib/jssdk/1.1.1/build/ly.js"></script>

</head>

<body>
    <div class="wrap">
        <header class="header">
            <img src="https://www.adtais.com/ximalaya/by-health/images/pic_share.jpg" style="display: none;" alt="" />
        </header>
        <section class="video">
            <div class="video__content">
                <div class="video__border ready">
                    <video id="video" src="./video/byhealth.mp4" preload="auto" 
                        poster="./images/pic_cover2.jpg" webkit-playsinline="true" playsinline="true"
                        x-webkit-airplay="allow" x5-video-player-type="h5" x5-video-player-fullscreen="true"
                        x5-video-orientation="portraint" style="object-fit:fill; ">
                    </video>
                </div>
            </div>
        </section>
        <section class="list">
            <div class="list__content">
                <a href="https://m.ximalaya.com/sound/674198723" class="list__item"><i class="list__img"><img src="./images/pic_head_1.jpg" /></i><span></span></a>
                <a href="https://m.ximalaya.com/sound/674721651" class="list__item"><i class="list__img"><img src="./images/pic_head_2.jpg" /></i><span></span></a>
                <a href="https://m.ximalaya.com/sound/674675452" class="list__item"><i class="list__img"><img src="./images/pic_head_3.jpg" /></i><span></span></a>
                <a href="https://m.ximalaya.com/sound/675110638" class="list__item"><i class="list__img"><img src="./images/pic_head_4.jpg" /></i><span></span></a>
                <div class="button__more">
                    <a class="button" href="" id="list_more">查看更多信息</a>
                    <i></i>
                </div>
            </div>
        </section>
        <section class="buy">
            <div class="buy__content">
                <a href="" class="buy__link" id="buy-link1"></a>
                <a href="" class="buy__link" id="buy-link2"></a>
            </div>
        </section>
        <section class="prize">
            <div class="prize__content">
                <div class="prize__pie" id="prize-pie">
                    <!-- <div class="prize__item">1111</div>
                    <div class="prize__item">2222</div>
                    <div class="prize__item">333</div>
                    <div class="prize__item">4444</div>
                    <div class="prize__item">5555</div>
                    <div class="prize__item">6666</div>
                    <div class="prize__item">77777</div>
                    <div class="prize__item">88888</div> -->
                </div>
                <div class="prize__button" style="filter: grayscale(100%);" id="prize-start">
                    <p>活动已结束</p>
                </div>
            </div>
            <div class="button__more">
                <span class="button fn-hide" id="prize-own">查看我的奖品</span>
                <a href="./list.html" class="button" id="prize-list">查看获奖名单</a>
            </div>
            <div class="prize__miss" id="prize-miss">
                <div class="mask__title title2"></div>
                <img src="./images/prize_miss.png" alt="" />
                <p>您与奖品擦肩而过...</p>
            </div>
        </section>
        <section class="rules"></section>
        <section class="bottom"></section>
        <section class="mask fn-hide">
            <!-- 奖品 -->
            <div class="mask__box" id="reward">
                <div class="mask__close"></div>
                <div class="mask__content"></div>
            </div>
        </section>
    </div>

    <script src="./js/jquery-3.7.0.min.js"></script>
    <script src="./js/swiper-bundle.min.js"></script>
    <script src="./js/index.js?1022"></script>

    <script>
        $(function () {
            var basicSiteUrl = 'https://www.adtais.com';
            var ua = window.navigator.userAgent.toLowerCase();
            var inApp = ua.indexOf('iting') > -1; //是否在APP内
            var inWeixin = ua.indexOf('micromessenger') > -1; //是否在微信内
            var opt = {
                title: '好营养 源来有话说',
                desc: '从好原料到好营养，一起来聆听营养源头的自然之声',
                img: basicSiteUrl + '/ximalaya/by-health/images/pic_share.jpg',
                link: basicSiteUrl + '/ximalaya/by-health/',
            };
            var pie = $('#prize-pie');
            var prizeMiss = $('#prize-miss');
            var prizeStart = $('#prize-start');
            var prizeOwn = $('#prize-own');
            var prizeList = $('#prize-list');
            var sharePic = $('.sharePic');
            var videoBox = $('.video__border');
            var video = document.getElementById('video');
            var mask = {
                bg: $('.mask'),
                reward: $('#reward'),
                rewardContent: $('#reward .mask__content'),
                close: $('#reward .mask__close'),
            };

            var xmsdk = window.xmsdk;
            var query = getQueryParams(document.location.search) || {}; // 地址栏链接的查询参数

            var prizeCount = 0; // 抽奖次数
            var prizeTypes = []; // 抽奖类型
            var isTurning = false; // 是否正在转动
            var playing = false; // 是否正在播放
            var winnerList = []; // 中奖名单
            var myPrize = []; // 我的奖品
            var accessToke = cookieset.get('_h5_access_token') || '';

            var getPostOpt = function() {
                return {
                    token: accessToke,
                    timeCode: Date.now(),
                    usertype: 'xm',
                };
            };

            xmsdk.config({
                app_key: 'bfb9e9d41b7728d326fca80551de15d6',
                debug: true, // 是否在控制台打印日志
                get_access_token: getAccessToken,
            });
            var xmly = new xmsdk.XMLY();

            (function () {
                $('#buy-link1').attr('href', inWeixin
                    ? 'https://equity.tmall.com/tm?agentId=2198452&bc_fl_src=tmall_market_llb_1_2363079&llbPlatform=_pube&llbOsd=1'
                    : 'tbopen://m.taobao.com/tbopen/index.html?&action=ali.open.nav&module=h5&source=liuliangbao&h5Url=https%3A%2F%2Fdetail.tmall.com%2Fitem.htm%3Fabbucket%3D7%26id%3D727928297908%26_bind%3Dtrue%26bc_fl_src%3Dtmall_market_llb_1_2363079%26llbPlatform%3Dximalaya%26agentId%3D2198452%26spm%3Da224e.7913437.1.2363079%26llbDlk%3D1&backURL=iting%3A%2F%2Fopen&appkey=25801606&bc_fl_src=tmall_market_llb_1_2363079');
                $('#buy-link2').attr('href', inWeixin
                    ? 'https://equity.tmall.com/tm?agentId=2198450&bc_fl_src=tmall_market_llb_1_2363077&llbPlatform=_pube&llbOsd=1'
                    : 'tbopen://m.taobao.com/tbopen/index.html?&action=ali.open.nav&module=h5&source=liuliangbao&h5Url=https%3A%2F%2Fmo.m.tmall.com%2Fpage%2F5407095%3Fshop_id%3D68994742%26_bind%3Dtrue%26bc_fl_src%3Dtmall_market_llb_1_2363077%26llbPlatform%3Dximalaya%26agentId%3D2198450%26spm%3Da224e.7913437.1.2363077%26llbDlk%3D1&backURL=iting%3A%2F%2Fopen&appkey=25801606&bc_fl_src=tmall_market_llb_1_2363077');
                $('#list_more').attr('href', inApp ? 'iting://open?msg_type=280&metadataValueId=1723837&pageType=new&userType=user' : 'https://m.ximalaya.com/gatekeeper/topic-share-h5?tagId=1723837');

                cookieset.set('prizeCountType', '1', {
                    expires: 365 * 24 * 60 * 60 * 1000,
                });
            })()

            // 活动结束，代码下线
            function everyDayCount(id, fn) {}

            function missPrize() {
                prizeMiss.addClass('active');
                setTimeout(function () {
                    prizeMiss.removeClass('active');
                }, 1800);
            }

            function getMaskTxt(setting) {
                var t = '';
                t += '<div class="mask__img"><img src="./images/prize_' + setting.id + '.png" alt="" />';
                t += '<div class="mask__txt">' + setting.prize + '</div>';
                if (setting.txt) {
                    t += '<div class="mask__subTxt">' + setting.txt + '</div></div><p class="mask__border"></p>';
                    if (setting.name && setting.phone && setting.address) {
                        t += '<div class="mask__title title6"></div><dl>';
                        t += '<dt>收件人</dt><dd><p>' + setting.name + '</p></dd>';
                        t += '<dt>手机号</dt><dd><p>' + setting.phone + '</p></dd>';
                        t += '<dt>收件地址</dt><dd><p>' + setting.address + '</p></dd></dl><p class="mask__border"></p>';
                    } else {
                        t += '<div class="mask__title title4"></div><dl>';
                        t += '<dt>收件人</dt><dd><input type="text" id="winner_name" /></dd>';
                        t += '<dt>手机号</dt><dd><input type="tel" maxlength="11" id="winner_phone" /></dd>';
                        t += '<dt>收件地址</dt><dd><input type="text" id="winner_address" /></dd></dl>';
                        t += '<div class="button__more"><span class="button">提交信息</span></div>'
                        mask.close.addClass('disabled');
                    }
                    t += '<div class="mask__tips">* 用户中奖后，可在当前页面查看中奖信息<br/> * 奖品将由汤臣倍健官方渠道派发</div>'
                } else {
                    t += '<p class="mask__border"></p><div class="mask__code"><div><p>兑换码</p><strong>' + setting.prizeCode + '</strong></div>';
                    t += '<div><span onClick="copyText(\'' + setting.prizeCode + '\')">复制</span></div></div>';
                    t += '<p class="mask__border"></p>';
                    t += '<div class="mask__tips">* 用户中奖后，可在当前页面查看兑换码获取中奖信息<br/>* 兑换方式：登录喜马拉雅APP—账号—我的钱包—兑换码，输入兑换码即可<br/>* 兑换有效期截止2024年10月15日14:00，还请尽快兑换使用</div>';
                }
                return t;
            }

            // type: 0 / 1
            // id: 0 - 7
            // prize: '某某某'
            // name, phone, address
            // prizeCode: '123123ssdfsdf'
            // txt: '阿第三方阿斯蒂芬阿斯蒂芬'
            function showMask(setting) {
                if (setting && typeof setting === 'object') {
                    var t = '';
                    t += '<div class="mask__title title' + (setting.type ? 5 : 3) + '"></div>';
                    if (setting.array && setting.array.length > 1) {
                        t += '<div class="swiper"><div class="swiper-wrapper">';
                        setting.array.forEach(function (item) {
                            t += '<div class="swiper-slide">';
                            t += getMaskTxt(item);
                            t += '</div>';
                        });
                        t += '</div><div class="swiper-pagination" style="bottom: auto; top: 0;"></div></div>';
                    } else if (setting.array && setting.array.length === 1) {
                        t += getMaskTxt(setting.array[0]);
                    } else {
                        t += getMaskTxt(setting);
                    }
                    mask.rewardContent.html(t);
                }
                mask.bg.removeClass('fn-hide');
                $('body').css('overflow', 'hidden');
            }

            $('#video').on('click', function () {
                if (!playing) {
                    everyDayCount(4);
                    video.play();
                    // 埋点
                    aplus_queue.push({
                        action: 'aplus.record',
                        arguments: ['byhealth_tvc', 'CLK']
                    });
                } else {
                    video.pause();
                }
            });
            video.onplay = function () {
                playing = true;
                videoBox.removeClass('ready');
            };
            video.onpause = function () {
                playing = false;
                videoBox.addClass('ready');
            };

            mask.close.on('click', function () {
                if ($(this).hasClass('disabled')) return;
                mask.bg.addClass('fn-hide');
                $('body').css('overflow', '');
            });

            // 埋点
            $('.list__content .list__item').each(function (i) {
                $(this).click(function () {
                    var href = $(this).attr('href');
                    everyDayCount(6, function () {
                        location.href = href;
                    });
                    aplus_queue.push({
                        action: 'aplus.record',
                        arguments: ['byhealth_audio' + (i + 1), 'CLK']
                    });
                    return false;
                });
            });
            $('.list__content .button__more').click(function (i) {
                aplus_queue.push({
                    action: 'aplus.record',
                    arguments: ['byhealth_more', 'CLK']
                });
            });
            $('.buy__content .buy__link').each(function (i) {
                $(this).click(function () {
                    var href = $(this).attr('href');
                    everyDayCount(7, function () {
                        location.href = href;
                    });
                    aplus_queue.push({
                        action: 'aplus.record',
                        arguments: ['byhealth_link' + (i + 1), 'CLK']
                    });
                    return false;
                });
            });

            prizeOwn.on('click', function () {
                aplus_queue.push({
                    action: 'aplus.record',
                    arguments: ['byhealth_myPrize', 'CLK']
                });
                showMask({
                    array: myPrize,
                    type: 1,
                });
                var mySwiper = new Swiper ('.swiper', {
                    loop: true, // 循环模式选项
                    
                    // 如果需要分页器
                    pagination: {
                    el: '.swiper-pagination',
                    },
                })     
            });

            mask.rewardContent.on('click', '.button', function () {
                var name = $('#winner_name').val();
                var phone = $('#winner_phone').val();
                var address = $('#winner_address').val();
                if (name && phone && address && /^1[3-9]\d{9}$/.test(phone)) {
                    var beSure = confirm('请确认信息无误，提交后不可修改！');
                    // 提交中奖信息
                    if (beSure) post({
                        url: basicSiteUrl + '/tais-boot/h5/site/prizeUserDo',
                        data: {
                            token: accessToke,
                            realName: name,
                            phone: phone,
                            address: address,
                            timeCode: Date.now(),
                            supplierCode: 2,
                            usertype: 'xm',
                        },
                        callback: function (data) {
                            getMyPrize();
                            mask.close.removeClass('disabled');
                            mask.bg.addClass('fn-hide');
                            $('body').css('overflow', '');
                        }
                    });
                } else {
                    alert('请填写完整信息！');
                }
            });

            $('#prize-start').on('click', function () {
                return;

                aplus_queue.push({
                    action: 'aplus.record',
                    arguments: ['byhealth_turntable', 'CLK', {
                        source: inApp ? 'app' : inWeixin ? 'weixin' : 'other',
                    }],
                });
            });

            prizeList.on('click', function() {
                aplus_queue.push({
                    action: 'aplus.record',
                    arguments: ['byhealth_prizeList', 'CLK']
                });
            });

            function setShare() {
                ly.invokeApp('util.share', {
                    channel: ['weixin', 'weixinGroup', 'xmTimeline', 'xmGroup', 'qzone', 'qq', 'tSina'],
                    title: opt.title,
                    desc: opt.desc,
                    link: opt.link,
                    imgUrl: opt.img,
                    type: 'link',
                    success: function (data) {
                        everyDayCount(5);
                        aplus_queue.push({
                            action: 'aplus.record',
                            arguments: ['byhealth_share', 'CLK', {
                                shareType: data.channel,
                            }]
                        });
                    },
                });
            };

            post({
                url: basicSiteUrl + '/tais-boot/sys/weixinAllJsAuthorization',
                data: { codeLink: window.location.href.split('#')[0] },
                callback: function (data) {
                    if (data.code == 200) {
                        wx.config({
                            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                            appId: data.result.appId, // 必填，公众号的唯一标识
                            timestamp: data.result.timestamp, // 必填，生成签名的时间戳
                            nonceStr: data.result.nonceStr, // 必填，生成签名的随机串
                            signature: data.result.signature, // 必填，签名
                            jsApiList: ['updateTimelineShareData', 'updateAppMessageShareData'],
                        });
                        wx.ready(function () {
                            wx.updateTimelineShareData({
                                title: opt.title, // 分享标题
                                link: opt.link, // 分享链接
                                imgUrl: opt.img, // 分享图标
                                success: function () {
                                    // 用户确认分享后执行的回调函数
                                    everyDayCount(5);
                                    aplus_queue.push({
                                        action: 'aplus.record',
                                        arguments: ['byhealth_share', 'CLK', {
                                            shareType: '朋友圈',
                                        }],
                                    });
                                },
                            });
                            wx.updateAppMessageShareData({
                                title: opt.title, // 分享标题
                                desc: opt.desc, // 分享描述
                                link: opt.link, // 分享链接
                                imgUrl: opt.img,
                                success: function () {
                                    // 用户确认分享后执行的回调函数
                                    everyDayCount(5);
                                    aplus_queue.push({
                                        action: 'aplus.record',
                                        arguments: ['byhealth_share', 'CLK', {
                                            shareType: '微信好友',
                                        }],
                                    });
                                },
                            });
                        });

                    } else {
                        alert('分享错误！');
                    }
                }
            })

            post({
                url: basicSiteUrl + '/tais-boot/h5/site/xmlyZzShareJsAuthorization',
                data: { codeLink: opt.link },
                callback: function (data) {
                    if (data.code == 200) {
                        var apiList = ['nav.setMenu', 'util.share', 'account.login'];
                        ly.config({
                            timestamp: data.result.timestamp,
                            nonce: data.result.nonceStr,
                            signature: data.result.signature,
                            appId: data.result.appId, // 必填，应用ID
                            apiList: apiList,
                        });
                        ly.ready(function () {
                            console.log('走不进来的ready');
                            ly.invokeApp('nav.setMenu', {
                                items: [
                                    {
                                        id: '1',
                                        icon: 'share',
                                        text: '分享',
                                    },
                                ],
                                success() {
                                    setShare();
                                },
                            });
                        });
                        ly.error(function (err) {
                            console.warn(JSON.stringify(err));
                        });
                    }
                }
            });

            // 上报 PV
            aplus_queue.push({
                action: 'aplus.sendPV',
                arguments: [{ is_auto: false }, {
                    // 这里传参
                }]
            });
        });
    </script>
</body>

</html>